{"version":3,"sources":["pages/msg/msg.uvue","pages/long-list/long-list-page.uvue","store/user.uts","common/socket.uts","pages/index/index.uvue?type=page","pages/msg/msg.uvue?type=page"],"sourcesContent":["<template>\r\n\r\n\t<scroll-view style=\"flex:1\">\r\n\r\n\t\t<view class=\"msg-item\" hover-class=\"msg-item-hover\" v-for=\"(item,index) in list\" :key=\"index\" @click=\"openChat(item)\">\r\n\t\t\t<avatar :src=\"item.avatar\" width=\"100rpx\" height=\"100rpx\" style=\"margin-right: 20rpx;\"></avatar>\r\n\t\t\t<view class=\"msg-item-body\">\r\n\t\t\t\t<text class=\"msg-item-nickname\">{{ item.name }}</text>\r\n\t\t\t\t<text class=\"msg-item-content\">{{ item.last_msg_note }}</text>\r\n\t\t\t</view>\r\n\t\t\t<view class=\"msg-item-info\">\r\n\t\t\t\t<text class=\"msg-item-time\">{{ item.update_time }}</text>\r\n\t\t\t\t<text class=\"msg-item-badge\" v-if=\"item.unread_count > 0\">{{ item.unread_count > 99 ? '99+' : item.unread_count }}</text>\r\n\t\t\t</view>\r\n\t\t</view>\r\n\t\t\r\n\t\t<!-- 暂无数据 -->\r\n\t\t<tip v-if=\"!isFirstLoad && list.length == 0\"></tip>\r\n\t\t\r\n\t\t<loading-more v-if=\"isFirstLoad || list.length > 0\" :loading=\"loading\" :isEnded=\"isEnded\"></loading-more>\r\n\r\n\t</scroll-view>\r\n\r\n</template>\r\n\r\n<script>\r\n\timport { Conversation,ConversationResult,Result } from '@/common/type.uts';\r\n\timport { getURL } from \"@/common/request.uts\"\r\n\timport { getToken,loginState } from \"@/store/user.uts\"\r\n\timport { openSocket } from \"@/common/socket.uts\"\r\n\texport default {\r\n\t\tdata() {\r\n\t\t\treturn {\r\n\t\t\t\tlist: [] as Conversation[],\r\n\t\t\t\tloading: false,\r\n\t\t\t\tisEnded: false,\r\n\t\t\t\tcurrentPage: 1,\r\n\t\t\t\tisFirstLoad:true\r\n\t\t\t}\r\n\t\t},\r\n\t\tonLoad() {\r\n\t\t\tthis.refreshData(null)\r\n\t\t\t// 监听会话变化\r\n\t\t\tuni.$on(\"onUpdateConversation\",this.onUpdateConversation)\r\n\t\t\tuni.$on(\"onUpdateNoReadCount\",this.onUpdateNoReadCount)\r\n\t\t},\r\n\t\tonShow(){\r\n\t\t\tif(this.loginState){\r\n\t\t\t\topenSocket()\r\n\t\t\t}\r\n\t\t},\r\n\t\tonUnload() {\r\n\t\t\tuni.$off(\"onUpdateConversation\",this.onUpdateConversation)\r\n\t\t\tuni.$off(\"onUpdateNoReadCount\",this.onUpdateNoReadCount)\r\n\t\t},\r\n\t\tonPullDownRefresh() {\r\n\t\t\tthis.refreshData(()=>{\r\n\t\t\t\tuni.showToast({\r\n\t\t\t\t\ttitle: '刷新成功',\r\n\t\t\t\t\ticon: 'none'\r\n\t\t\t\t});\r\n\t\t\t\tuni.stopPullDownRefresh()\r\n\t\t\t})\r\n\t\t},\r\n\t\tonReachBottom() {\r\n\t\t\tthis.loadData(null)\r\n\t\t},\r\n\t\tcomputed: {\r\n\t\t\t// 登录状态\r\n\t\t\tloginState(): boolean {\r\n\t\t\t\treturn loginState.value\r\n\t\t\t}\r\n\t\t},\r\n\t\tmethods: {\r\n\t\t\tonUpdateNoReadCount(id:number){\r\n\t\t\t\tlet item = this.list.find((o:Conversation):boolean => o.id == id)\r\n\t\t\t\tif(item != null){\r\n\t\t\t\t\titem.unread_count = 0\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\t// 监听会话变化\r\n\t\t\tonUpdateConversation(e:Conversation | null){\r\n\t\t\t\t// 登录或者退出触发\r\n\t\t\t\tif(e == null){\r\n\t\t\t\t\t// 已登录，直接刷新数据\r\n\t\t\t\t\tif(this.loginState){\r\n\t\t\t\t\t\tthis.refreshData(null)\r\n\t\t\t\t\t}\r\n\t\t\t\t\t// 退出登录，清除会话列表\r\n\t\t\t\t\telse {\r\n\t\t\t\t\t\tthis.list.length = 0\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn\r\n\t\t\t\t}\r\n\t\t\t\t// 发起会话 或 聊天中 触发\r\n\t\t\t\t// 查询会话是否存在\r\n\t\t\t\tlet i = this.list.findIndex((o:Conversation):boolean => {\r\n\t\t\t\t\treturn o.id == e.id\r\n\t\t\t\t})\r\n\t\t\t\t// 不存在直接刷新\r\n\t\t\t\tif(i == -1){\r\n\t\t\t\t\tthis.refreshData(null)\r\n\t\t\t\t\treturn\r\n\t\t\t\t}\r\n\t\t\t\t// 存在则修改并置顶\r\n\t\t\t\tthis.list[i].avatar = e.avatar\r\n\t\t\t\tthis.list[i].name = e.name\r\n\t\t\t\tthis.list[i].last_msg_note = e.last_msg_note\r\n\t\t\t\tthis.list[i].unread_count = e.unread_count\r\n\t\t\t\tthis.list[i].update_time = e.update_time\r\n\t\t\t\tthis._toFirst(this.list,i)\r\n\t\t\t},\r\n\t\t\t// 数组置顶\r\n\t\t\t_toFirst(arr: Conversation[], index : number) : Conversation[]{\r\n\t\t\t\tif(index != 0){\r\n\t\t\t\t\tarr.unshift(arr.splice(index,1)[0])\r\n\t\t\t\t}\r\n\t\t\t\treturn arr;\r\n\t\t\t},\r\n\t\t\topenChat(item : Conversation){\r\n\t\t\t\tuni.navigateTo({\r\n\t\t\t\t\turl: `/pages/chat/chat?id=${item.id}&target_id=${item.target_id}&title=${item.name}`\r\n\t\t\t\t});\r\n\t\t\t},\r\n\t\t\trefreshData(loadComplete : (() => void) | null) {\r\n\t\t\t\tthis.list.length = 0\r\n\t\t\t\tthis.currentPage = 1\r\n\t\t\t\tthis.isFirstLoad = true\r\n\t\t\t\tthis.isEnded = false\r\n\t\t\t\tthis.loading = false\r\n\t\t\t\tthis.loadData(loadComplete)\r\n\t\t\t},\r\n\t\t\tloadData(loadComplete : (() => void) | null) {\r\n\t\t\t\tif (this.loading || this.isEnded) {\r\n\t\t\t\t\treturn\r\n\t\t\t\t}\r\n\t\t\t\tthis.loading = true\r\n\t\t\t\tuni.request<Result<ConversationResult>>({\r\n\t\t\t\t\turl: getURL(`/im/conversation/${Math.floor(this.currentPage)}`),\r\n\t\t\t\t\theader:{\r\n\t\t\t\t\t\ttoken:getToken()\r\n\t\t\t\t\t},\r\n\t\t\t\t\tsuccess: (res) => {\r\n\t\t\t\t\t\tlet r = res.data\r\n\t\t\t\t\t\tif(r == null) return\r\n\t\t\t\t\t\tif(res.statusCode !=200){\r\n\t\t\t\t\t\t\tuni.showToast({\r\n\t\t\t\t\t\t\t\ttitle: r.msg,\r\n\t\t\t\t\t\t\t\ticon: 'none'\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\treturn\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tconst resData = r.data as ConversationResult | null\r\n\t\t\t\t\t\tif(resData == null) return\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t// 是否还有数据\r\n\t\t\t\t\t\tthis.isEnded = resData.last_page <= resData.current_page\r\n\t\t\t\t\t\tif(this.currentPage == 1){\r\n\t\t\t\t\t\t\tthis.list = resData.data\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tthis.list.push(...resData.data)\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t// 页码+1\r\n\t\t\t\t\t\tthis.currentPage = this.isEnded ? resData.current_page : Math.floor(resData.current_page + 1)\r\n\t\t\t\t\t},\r\n\t\t\t\t\tfail: (err) => {\r\n\t\t\t\t\t\tuni.showToast({\r\n\t\t\t\t\t\t\ttitle: err.errMsg,\r\n\t\t\t\t\t\t\ticon: 'none'\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t},\r\n\t\t\t\t\tcomplete: () => {\r\n\t\t\t\t\t\tthis.loading = false\r\n\t\t\t\t\t\tthis.isFirstLoad = false\r\n\t\t\t\t\t\tif (loadComplete != null) {\r\n\t\t\t\t\t\t\tloadComplete()\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t})\r\n\t\t\t},\r\n\t\t}\r\n\t}\r\n</script>\r\n\r\n<style>\r\n.msg-item {\r\n\tflex-direction: row;\r\n\talign-items: stretch;\r\n\tpadding: 20rpx 30rpx;\r\n}\r\n.msg-item-hover {\r\n\tbackground-color: #f4f4f4;\r\n}\r\n.msg-item-body {\r\n\tmax-width: 420rpx;\r\n}\r\n.msg-item-nickname {\r\n\tfont-size: 17px;\r\n\tfont-weight: bold;\r\n\tmargin: 10rpx 0;\r\n\tlines: 1;\r\n}\r\n.msg-item-content {\r\n\tfont-size: 14px;\r\n\tcolor: #727272;\r\n\tlines: 1;\r\n}\r\n.msg-item-info {\r\n\tmargin-left: auto;\r\n\talign-items: flex-end;\r\n\tflex-shrink: 0;\r\n}\r\n.msg-item-time {\r\n\tfont-size: 12px;\r\n\tcolor: #777777;\r\n\tmargin: 10rpx 0;\r\n}\r\n.msg-item-badge {\r\n\tcolor: #ffffff;\r\n\tbackground-color: #f84c2f;\r\n\tfont-size: 11px;\r\n\tpadding: 4rpx 8rpx;\r\n\tborder-radius: 30rpx;\r\n\tfont-weight: bold;\r\n}\r\n</style>",null,null,null,null,null],"names":[],"mappings":"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"}